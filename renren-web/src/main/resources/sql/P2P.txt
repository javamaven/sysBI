SELECT 
  STAT_TYPE,
  STAT_NUM
FROM (
select
 '累计成交量（万元）' AS STAT_TYPE,
 round(sum(jiaoyie),2) as STAT_NUM
 from
(
SELECT  -- 点点赚
  SUM(ddzb.project_scale)/10000  AS jiaoyie -- 点点赚交易额
  FROM mdtxbi.edw_trading_ddz_borrow ddzb
WHERE to_char(ddzb.ISSUE_DATE, 'yyyymmdd')< '${investEndTime}' -- 官网点点赚没有在凌晨直接加当天再投，故取时点值取小于
union all
select -- 截止某一天的交易额（项目和债转，按照实际成交时间)
 sum(case when pd.tender_subject=2 then pd.tend_cash else pd.tender_capital end)/10000 as jiaoyie
 from mdtxbi.edw_trading_project_detail pd
 where
 pd.tender_account_status=1
 and to_char(pd.addtime,'yyyymmdd')<='${investEndTime}'
)

UNION ALL


--本月成交量（万元）
select
 '本月成交量（万元）',
 round(sum(jiaoyie),2) as yuechengjiao
 from
(
SELECT  -- 点点赚
  SUM(ddzb.project_scale)/10000  AS jiaoyie -- 点点赚交易额
  FROM mdtxbi.edw_trading_ddz_borrow ddzb
WHERE to_char(ddzb.ISSUE_DATE, 'yyyymmdd') between '${investStatTime}' and '${investEndTime}'
union all
select -- 截止某一天的交易额（项目和债转，按照实际成交时间)
 sum(case when pd.tender_subject=2 then pd.tend_cash else pd.tender_capital end)/10000 as jiaoyie
 from mdtxbi.edw_trading_project_detail pd
 where
 pd.tender_account_status=1
 and to_char(pd.addtime,'yyyymmdd') between '${investStatTime}' and '${investEndTime}'
)

UNION ALL
-- 当前待收余额（万元
select 
'当前待收余额（万元）',
round(
SUM(
CASE WHEN to_char(rpp.REPAY_DATE,'yyyyMMdd') > '${investEndTime}'
   AND ( to_char(rpd.settle_end_time,'yyyyMMdd') > '${investEndTime}' OR rpd.settle_end_time IS NULL)
  THEN (rpp.repay_capital+rpp.repay_interest)
ELSE 0 END)/10000,2) AS REPAY_account_WAIT -- 待收本息
FROM
mdtxbi.edw_trading_repay_plan rpp
left join mdtxbi.dm_trading_repay_detail rpd
 on (rpp.project_id=rpd.project_id and rpp.period=rpd.period)
where
  to_char(rpp.create_time,'yyyyMMdd') <= '${investEndTime}'
  and rpp.repay_status<>3 



UNION ALL

-- 累计出借人次
select 
'累计出借人次',count(1)
from 
mdtxbi.edw_trading_project_detail pd
where to_char(pd.addtime,'yyyymmdd') <='${investEndTime}'
and pd.tender_account_status=1

UNION ALL

-- 当前出借人数
select 
'当前出借人数',count(1) 
from 
mdtxbi.edw_trading_project_detail pd
where to_char(pd.addtime,'yyyymmdd') between '${investStatTime}' and '${investEndTime}'
and pd.tender_account_status=1

UNION ALL
----单笔借款平均金额（万元）,单笔借款平均期限（月）出借人收益率范围，最小,出借人收益率范围，最大,出借人平均收益率

select * from (
with hbb as
(
select
pj.borrow_account as account,
to_char(pj.project_complete_date,'yyyymmdd') as reverify_time, -- 按照项目满标时间
case
  when borrow_term_unit=1 then pj.borrow_term
  when borrow_term_unit=2 then pj.borrow_period*30
end as period,
(pj.borrow_apr+nvl(pj.borrow_apr_extra,0)) as apr
from mdtxbi.edw_trading_project pj
where pj.stage in (5,8)
and pj.project_id not like 'ZT%'
),
hbb_a as(
select
'单笔借款平均金额（万元）' AS STAT_TYPE,round(avg(hbb.account)/10000,2) as avg_account -- 单笔借款平均金额（万元）
from hbb
where hbb.reverify_time between '${investStatTime}' and '${investEndTime}'
),
hbb_b as(
select
'单笔借款平均期限（月）' AS STAT_TYPE,round(sum(hbb.period*hbb.account)/sum(hbb.account)/30,2)  as avg_period_i-- 单笔借款平均期限（月）
from hbb
where hbb.reverify_time between '${investStatTime}' and '${investEndTime}'
),
hbb_c as(
select
'出借人收益率最小值' AS STAT_TYPE,min(hbb.apr) min_apr -- 出借人收益率范围，最小
from hbb
where hbb.reverify_time between '${investStatTime}' and '${investEndTime}'
),
hbb_d as(
select
'出借人收益率最大值' AS STAT_TYPE,max(hbb.apr) max_apr -- 出借人收益率范围，最大
from hbb
where hbb.reverify_time between '${investStatTime}' and '${investEndTime}'
),
hbb_e as(
select
'出借人平均收益率' AS STAT_TYPE,round(sum(hbb.apr*hbb.account)/sum(hbb.account),2) avg_apr_i -- 出借人平均收益率
from hbb
where hbb.reverify_time between '${investStatTime}' and '${investEndTime}'
)
select * from hbb_a 
union all
select * from hbb_b 
union all
select * from hbb_c 
union all
select * from hbb_d 
union all
select * from hbb_e 
)s
)


