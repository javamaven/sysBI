--SQL 所用到的变量： 月：'${month}'  日：'${period}'

WITH SUPPLY AS (
  SELECT
    DECODE(BORROW_TERM_UNIT,1,DECODE(ROUND(BORROW_TERM/30,0),0,1,ROUND(BORROW_TERM/30,0)),BORROW_TERM)  PERIOD,
    SUM(CASE WHEN TO_CHAR(TP.TIME_PUBLISH,'yyyymmdd')<='${period}' THEN BORROW_ACCOUNT END) AS M_PUB,
    SUM(CASE WHEN TO_CHAR(TP.TIME_PUBLISH,'yyyymmdd') ='${period}' THEN BORROW_ACCOUNT END ) AS D_PUB,
    SUM(CASE WHEN IS_FINANCIAL=1 AND TO_CHAR(TP.TIME_PUBLISH,'yyyymmdd')<='${period}' THEN BORROW_ACCOUNT END) AS M_PUB_FIN --供应理财计划
  FROM EDW_TRADING_PROJECT TP 
    WHERE STAGE <>1  --1 项目待提交  
      AND PROJECT_ID NOT LIKE 'ZT%'  
      AND TO_CHAR(TP.TIME_PUBLISH,'yyyymm') ='${month}' 
  GROUP BY DECODE(BORROW_TERM_UNIT,1,DECODE(ROUND(BORROW_TERM/30,0),0,1,ROUND(BORROW_TERM/30,0)),BORROW_TERM) 
),

INV AS(
  SELECT
    DECODE(ROUND(BORROW_PERIOD/30,0),0,1,ROUND(BORROW_PERIOD/30,0)) AS PERIOD,
    SUM(CASE WHEN TO_CHAR(PD.ADDTIME,'yyyymmdd')<='${period}' THEN TENDER_CAPITAL END) AS M_INV,
    SUM(CASE WHEN TO_CHAR(PD.ADDTIME,'yyyymmdd') ='${period}' THEN TENDER_CAPITAL END ) AS D_INV,
    SUM(CASE WHEN TENDER_SUBJECT=1 AND TO_CHAR(PD.ADDTIME,'yyyymmdd')<='${period}' THEN TENDER_CAPITAL END) AS M_SAN,
    SUM(CASE WHEN TENDER_SUBJECT=1 AND TO_CHAR(PD.ADDTIME,'yyyymmdd') ='${period}' THEN TENDER_CAPITAL END ) AS D_SAN,
    SUM(CASE WHEN TENDER_SUBJECT=3 AND TO_CHAR(PD.ADDTIME,'yyyymmdd')<='${period}' THEN TENDER_CAPITAL END) AS M_FIN,
    SUM(CASE WHEN TENDER_SUBJECT=3 AND TO_CHAR(PD.ADDTIME,'yyyymmdd') ='${period}' THEN TENDER_CAPITAL END ) AS D_FIN  
  FROM EDW_TRADING_PROJECT_DETAIL PD 
  WHERE TENDER_ACCOUNT_STATUS IN (0,1)
    AND TO_CHAR(PD.ADDTIME,'yyyymm') ='${month}' 
    AND TENDER_SUBJECT IN (1,3,4)
  GROUP BY DECODE(ROUND(BORROW_PERIOD/30,0),0,1,ROUND(BORROW_PERIOD/30,0))
),
TMP AS(
SELECT
  CASE WHEN SUPPLY.PERIOD IS NULL AND INV.PERIOD IS NULL THEN '无期限'
    ELSE DECODE(SUPPLY.PERIOD,NULL,INV.PERIOD || '月',SUPPLY.PERIOD || '月') END AS PERIOD,
    
      round(m_pub,0)  as M_PUB,
  round(d_pub,0) as D_PUB,
  round(m_pub_fin,0) as M_PUB_FIN,
  round(m_inv,0) as M_INV,
  round(d_inv,0) as D_INV,
  round(m_san,0) as M_SAN,
  round(d_san,0) as D_SAN,
  round(m_fin,0) as M_FIN,
  round(d_fin,0) as D_FIN,
  
  CASE WHEN SUPPLY.PERIOD IS NULL AND INV.PERIOD IS NULL THEN 100
    ELSE DECODE(SUPPLY.PERIOD,NULL,INV.PERIOD ,SUPPLY.PERIOD ) END AS RANK
FROM SUPPLY
  FULL JOIN INV ON SUPPLY.PERIOD = INV.PERIOD
ORDER BY RANK ASC
)
SELECT * FROM (
SELECT
  PERIOD,  --资产期限
  M_PUB,   --当月资产供应
  ROUND(M_PUB/(SELECT SUM(M_PUB) FROM TMP),4) AS SUPPLY_RATE, --期限占比
  D_PUB,   --当日资产供应
  M_PUB_FIN,  --供应理财计划资产
  ROUND(M_PUB_FIN/(SELECT SUM(M_PUB_FIN) FROM TMP),4) AS SUPPLY_FIN_RATE, --期限占比
  M_INV,   --当月成交
  ROUND(M_INV/(SELECT SUM(M_INV) FROM TMP),4) AS INV_RATE,  --期限占比
  D_INV,  --当日成交
  M_SAN,  --当月散标成交
  D_SAN,  --当日散标成交
  M_FIN,  --当月理财计划成交
  D_FIN   --当日理财计划成交
FROM TMP
UNION ALL
SELECT
  '汇总',
  SUM(M_PUB),
  1.0000,
  SUM(D_PUB),
  SUM(M_PUB_FIN),  
  1.0000,
  SUM(M_INV),
  1.0000,
  SUM(D_INV),
  SUM(M_SAN),
  SUM(D_SAN),
  SUM(M_FIN),
  SUM(D_FIN) 
FROM TMP
)
${paixu}