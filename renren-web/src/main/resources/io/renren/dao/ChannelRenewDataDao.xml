<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.dao.ChannelRenewDataDao">

<sql id="channelCond">
	<if test="channelLabelList !=null and channelLabelList.size() != 0">
		AND c.channel_label IN
		<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
			#{channelName}
		</foreach>
	</if>
</sql>
<select id="queryDay90FirstInvestYearRoi" resultType="io.renren.entity.ChannelRenewDataEntity" fetchSize="2000">
<!-- 60日,首投年化ROI 传入不同参数，返回对应信息-->
	call first_invest_year_roi_renew_day90(#{startDate} , #{endDate})
</select>
<select id="queryDay60FirstInvestYearRoi" resultType="io.renren.entity.ChannelRenewDataEntity" fetchSize="2000">
<!-- 60日,首投年化ROI 传入不同参数，返回对应信息-->
	call first_invest_year_roi_renew_day60(#{startDate} , #{endDate})
</select>
<select id="queryDay30FirstInvestYearRoi" resultType="io.renren.entity.ChannelRenewDataEntity" fetchSize="2000">
<!-- 30日60日90日,首投年化ROI 传入不同参数，返回对应信息-->
	call first_invest_year_roi_renew_day30(#{startDate} , #{endDate})

</select>
<select id="queryFirstInvestUserNum" resultType="io.renren.entity.ChannelRenewDataEntity" fetchSize="2000">
<!-- 30日60日90日,首投用户数，首投金额，首投年华金额 传入不同参数，返回对应信息-->
<!-- 30日60日90日,复投用户数，复投金额，复投年华金额 传入不同参数，返回对应信息-->

	SET @rank = 0;
	SET @pa = NULL;
		select 
			u.activity_tag channelLabel,
			count(distinct s.user_id) firstInvestUserNum,
			sum(s.money) firstInvestAmount,
			sum(s.money * s.days / 360) firstInvestYearAmount
		from (
				SELECT
				IF (
					@pa = p.user_id ,@rank :=@rank + 1 ,@rank := 1
				) rownum ,
				@pa := p.user_id user_id,
				p.addtime,
				p.TENDER_CAPITAL money, 
				p.BORROW_PERIOD days
				FROM
					edw_merge_project_detail p
				ORDER BY
					p.user_id ASC,
					p.id
		) s , dm_report_merge_user u
		where 1=1
		and s.rownum= #{rownum}
		AND s.addTime >= #{startDate}
		AND s.addTime &lt;= #{endDate}
		<if test="channelLabelList !=null and channelLabelList.size() != 0">
			AND u.activity_tag IN
			<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
				#{channelName}
			</foreach>
		</if>
		and s.user_id=u.user_id
		group by u.activity_tag

</select>
<select id="queryYearRoi" resultType="io.renren.entity.ChannelRenewDataEntity">
<!-- 30日60日90日,年化ROI-->
select 
	s.channelLabel,
	sum(s.30dayroi) day30YearRoi,
	sum(s.60dayroi) day60YearRoi,
	sum(s.90dayroi) day90YearRoi
from (
	SELECT
		c.CHANNEL_LABEL channelLabel,
		case when sum(c.ROI) is null then 0 else sum(c.ROI) end 30dayroi, 
		0 60dayroi,
		0 90dayroi
	FROM
		DIM_CHANNEL_COST c
	where 1=1
		<include refid="channelCond"/>
		AND c.ctime >= #{day30}
		AND c.ctime &lt;= #{endDate}
	GROUP BY
		c.CHANNEL_LABEL
union ALL
	SELECT
		c.CHANNEL_LABEL channelLabel,
		0 30dayroi,
		case when sum(c.ROI) is null then 0 else sum(c.ROI) end 60dayroi,
		0 90dayroi
	FROM
		DIM_CHANNEL_COST c
	where 1=1
    	<include refid="channelCond"/>
		AND c.ctime >= #{day60}
		AND c.ctime &lt;= #{endDate}
	GROUP BY
		c.CHANNEL_LABEL
union ALL
	SELECT
		c.CHANNEL_LABEL channelLabel,
		0 30dayroi,
		0 60dayroi,
		case when sum(c.ROI) is null then 0 else sum(c.ROI) end 90dayroi
	FROM
		DIM_CHANNEL_COST c
	where 1=1
		<include refid="channelCond"/>
		AND c.ctime >= #{day90}
		AND c.ctime &lt;= #{endDate}
	GROUP BY
		c.CHANNEL_LABEL
) s
where 1=1
group by s.channelLabel


</select>

<select id="queryYearAmount" resultType="io.renren.entity.ChannelRenewDataEntity">
	<!-- 30日60日90日,年化投资金额 ,传入不同天数，返回对应年化金额-->
	
	SELECT
		u.ACTIVITY_TAG channelLabel,
		sum(
			p.TENDER_CAPITAL * p.BORROW_PERIOD / 360
		) yearAmount,
		sum(IFNULL(p.TENDER_CAPITAL,0)) amount
	FROM
		edw_merge_project_detail p,
		dm_report_merge_user u
	WHERE
		1 = 1
	AND p.USER_ID = u.USER_ID
	AND p.TENDER_SUBJECT IN (1, 2) 
	<if test="channelLabelList !=null and channelLabelList.size() != 0">
		AND u.ACTIVITY_TAG IN
		<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
			#{channelName}
		</foreach>
	</if>
	AND p.ADDTIME >= #{startDate}
	AND p.ADDTIME &lt;= #{endDate}
	GROUP BY
		u.ACTIVITY_TAG

</select>
<select id="queryOnlineTime" resultType="io.renren.entity.ChannelRenewDataEntity">
	SELECT
		c.CHANNEL_LABEL channelLabel,
		c.CHANNEL_STARTTIME onlineTime
	FROM
		dim_channel c
	WHERE
		1 = 1
	 <include refid="channelCond"/>
	order by c.CHANNEL_LABEL

</select>
<select id="queryChannelCost" resultType="io.renren.entity.ChannelRenewDataEntity">
<!-- 30日60日90日，费用 -->
SELECT 
	s.channel_label channelLabel, 
	sum(s.30dayMoney) day30Cost,
	sum(s.60dayMoney) day60Cost,
	sum(s.90dayMoney) day90Cost
FROM (
	SELECT
		c.channel_label,
		sum(case when c.actual_cost is null then 0 else c.actual_cost end ) 30dayMoney, 
		0 60dayMoney,
		0 90dayMoney
	FROM
		dim_channel_cost c
	WHERE
		1 = 1
	<include refid="channelCond"/>
	AND c.ctime >= #{day30}
	AND c.ctime &lt;= #{endDate}
	GROUP BY
		c.channel_label
union all 
	SELECT
		c.channel_label,
		0 30dayMoney,
		sum(case when c.actual_cost is null then 0 else c.actual_cost end ) 60dayMoney,
		0 90dayMoney
	FROM
		dim_channel_cost c
	WHERE
		1 = 1
	<include refid="channelCond"/>
	AND c.ctime >= #{day60}
	AND c.ctime &lt;= #{endDate}
	GROUP BY
		c.channel_label
union all 
	SELECT
		c.channel_label,
		0 30dayMoney,
		0 60dayMoney,
		sum(case when c.actual_cost is null then 0 else c.actual_cost end ) 90dayMoney
	FROM
		dim_channel_cost c
	WHERE
		1 = 1
	<include refid="channelCond"/>
	AND c.ctime >= #{day90}
	AND c.ctime &lt;= #{endDate}
	GROUP BY
		c.channel_label
) s
where 1=1
group by s.channel_label


</select>


</mapper>