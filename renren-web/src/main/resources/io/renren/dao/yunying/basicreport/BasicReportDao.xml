<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.dao.yunying.basicreport.BasicReportDao">

<!-- 	 电销外呼申请历史数据（注册未投资用户） -->
	<insert id="batchInsertPhoneSaleData" useGeneratedKeys="true" parameterType="java.util.List">  
	    insert into phone_sale_history_export (user_id, phone)   
	    values  
	    <foreach collection="list" item="item" index="index" separator="," >  
	         ( 
	         	#{item.用户ID}, 
	         	#{item.电话} 
	         )  
	    </foreach>  
	</insert> 

	<select id="queryFirstInvestNotMultiList" resultType="java.util.HashMap">
		SELECT
			u.USERNAME,
			u.CG_USER_ID,
			u.REALNAME,
			u.PHONE,
			u.REGISTER_TIME,
			u.DEPOSITORY_FIRSTINVEST_TIME,
			u.DEPOSITORY_FIRSTINVEST_BALANCE,
			p.BORROW_PERIOD
		FROM
			edw_user_basic u
		LEFT JOIN edw_trading_project_detail p ON (u.USER_ID = p.USER_ID)
		WHERE
			1 = 1
		AND date_format(u.REGISTER_TIME, '%Y-%m') = #{month}
		AND u.DEPOSITORY_FIRSTINVEST_TIME >= #{startTime}
		AND u.DEPOSITORY_FIRSTINVEST_TIME &lt;= #{endTime}
		<if test="userNameList != null and userNameList.size()!=0">
			AND (
				u.USERNAME IN 
				<foreach item="userName" collection="userNameList" open="(" separator="," close=")">
					#{userName}
				</foreach>
				OR u.PHONE IN 
				<foreach item="userName" collection="userNameList" open="(" separator="," close=")">
					#{userName}
				</foreach>
			)
		</if>
		GROUP BY
			u.USER_ID
		HAVING
			count(1) = 1
		order by u.register_time desc
		<if test="offset != null and limit != null">
			limit #{offset}, #{limit}
		</if>
	</select>
	
	<select id="queryFirstInvestNotMultiTotal" resultType="int">
		SELECT
			count(*)
		FROM
			(
				SELECT
					u.user_id
				FROM
					edw_user_basic u
				LEFT JOIN edw_trading_project_detail p ON (u.USER_ID = p.USER_ID)
				WHERE
					1 = 1
				AND date_format(u.REGISTER_TIME, '%Y-%m') = #{month}
				AND u.DEPOSITORY_FIRSTINVEST_TIME >= #{startTime}
				AND u.DEPOSITORY_FIRSTINVEST_TIME &lt;= #{endTime}
				<if test="userNameList != null and userNameList.size()!=0">
					AND (
						u.USERNAME IN 
						<foreach item="userName" collection="userNameList" open="(" separator="," close=")">
							#{userName}
						</foreach>
						OR u.PHONE IN 
						<foreach item="userName" collection="userNameList" open="(" separator="," close=")">
							#{userName}
						</foreach>
					)
				</if>
				GROUP BY
					u.USER_ID
				HAVING
					count(1) = 1
			) s
	</select>

	<select id="queryRegisterThreeDaysNotInvestList" resultType="java.util.HashMap">
	
		SELECT
			u.user_id 用户ID,
			u.USERNAME 用户名,
			u.PHONE 手机号,
			u.REGISTER_TIME 注册时间,
			d.CHANNEL_NAME 用户来源,
			case when u.REALNAME is null then '否' else '是' end 实名认证,
			u.REALNAME 真实姓名,
			'否' 是否投资,
			0 投资次数,
			'' 最近一次投资时间,
			'' 最近一次投资期限,
			0 账户余额
		FROM
			edw_user_basic u
		left join dim_channel d  on (u.ACTIVITY_TAG=d.CHANNEL_LABEL)
		WHERE
			1 = 1
		<if test="registerStartTime != null and registerStartTime.trim() != '' ">
		     <![CDATA[ and u.REGISTER_TIME >= #{registerStartTime}  ]]>
		</if>
		<if test="registerEndTime != null and registerEndTime.trim() != '' ">
		     <![CDATA[ and u.REGISTER_TIME <= #{registerEndTime}  ]]>
		</if>
		
		and u.DEPOSITORY_FIRSTINVEST_TIME is NULL
		and u.NORMAL_FIRSTINVEST_TIME is null
		and d.PAYMENT_WAY not like '%免费%'
		and d.PAYMENT_WAY not like '%测试%'
		and d.PAYMENT_WAY not like '%置换%'
		and d.PAYMENT_WAY not like '%CPS%'
		
		and d.CHANNEL_NAME not like '%免费%'
		and d.CHANNEL_NAME not like '%测试%'
		and d.CHANNEL_NAME not like '%置换%'
		and d.CHANNEL_NAME not like '%CPS%'
		
		AND d.CHANNEL_NAME not LIKE '%触宝%'
		AND d.CHANNEL_NAME not LIKE '%北瓜%'
		AND d.CHANNEL_NAME not LIKE '%360摇一摇%'
		
	</select>

</mapper>