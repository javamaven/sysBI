<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.dao.ChannelInvestTimesDao">

<select id="queryRegisterUserNum" resultType="io.renren.entity.ChannelInvestTimesEntity">
<!-- 注册人数 -->
SELECT
	u.ACTIVITY_TAG channelLabel,
	count(u.user_id) registerUserNum
FROM
	dm_report_merge_user u
WHERE
	1 = 1
<if test="regBeginDate != null and regBeginDate.trim() != '' ">
     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
</if>
<if test="regEndDate != null and regEndDate.trim() != '' "  >
     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
</if>
<if test="channelLabelList != null and channelLabelList.size()!=0">
	AND u.ACTIVITY_TAG IN
	<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
		#{channelName}
	</foreach>
</if>
GROUP BY
	u.ACTIVITY_TAG
</select>
	
<select id="queryFirstInvestUserNum" resultType="io.renren.entity.ChannelInvestTimesEntity">
	<!-- 首投人数,首投金额 -->
	SELECT
		u.ACTIVITY_TAG channelLabel,
		count(DISTINCT u.user_id) firstInvestUserNum,
		sum(stMoney) firstInvestAmount
	FROM
		(
			SELECT
				u.ACTIVITY_TAG,
				u.user_id,
				CASE WHEN u.NORMAL_FIRSTINVEST_TIME > u.DEPOSITORY_FIRSTINVEST_TIME THEN u.DEPOSITORY_FIRSTINVEST_TIME ELSE u.NORMAL_FIRSTINVEST_TIME END minTime,
				CASE WHEN u.NORMAL_FIRSTINVEST_TIME > u.DEPOSITORY_FIRSTINVEST_TIME THEN u.DEPOSITORY_FIRSTINVEST_BALANCE ELSE u.NORMAL_FIRSTINVEST_BALANCE END stMoney,
				CASE WHEN u.NORMAL_FIRSTINVEST_TIME > u.DEPOSITORY_FIRSTINVEST_TIME THEN u.DEPOSITORY_FIRSTINVEST_Y_MONEY ELSE u.NORMAL_FIRSTINVEST_Y_MONEY END stYearMoney
			FROM
				dm_report_merge_user u
			WHERE
				1 = 1
			<if test="channelLabelList != null and channelLabelList.size()!=0">
				AND u.ACTIVITY_TAG IN
				<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
					#{channelName}
				</foreach>
			</if>
			AND u.REGISTER_TIME >=  #{regBeginDate}
			AND u.REGISTER_TIME &lt;= #{regEndDate} 
			AND (
				(
					u.NORMAL_FIRSTINVEST_TIME IS NOT NULL
					AND u.NORMAL_FIRSTINVEST_TIME >=  #{regBeginDate}
					AND u.NORMAL_FIRSTINVEST_TIME &lt;= #{invEndDate}
				)
				OR (
					u.DEPOSITORY_FIRSTINVEST_TIME IS NOT NULL
					AND u.DEPOSITORY_FIRSTINVEST_TIME >=  #{regBeginDate}
					AND u.DEPOSITORY_FIRSTINVEST_TIME &lt;= #{invEndDate}
				)
			)
	) u
	WHERE
		1 = 1
	AND u.minTime >=  #{regBeginDate}
	AND u.minTime &lt;= #{invEndDate}
	GROUP BY
		u.ACTIVITY_TAG

</select>	

<select id="queryInvestTimes" resultType="io.renren.entity.ChannelInvestTimesEntity">
<!-- 投资次数 -->
SELECT
	u.ACTIVITY_TAG channelLabel,
	count(1) investTimes
FROM
	edw_merge_project_detail p,
	dm_report_merge_user u
WHERE
	1 = 1
AND p.USER_ID = u.USER_ID
<if test="regBeginDate != null and regBeginDate.trim() != '' ">
     <![CDATA[ and p.ADDTIME  >=  #{regBeginDate}  ]]>
</if>
<if test="invEndDate != null and invEndDate.trim() != '' "  >
     <![CDATA[ and p.ADDTIME <=  #{invEndDate}  ]]>
</if>
AND p.TENDER_SUBJECT IN (1, 2)
<if test="regBeginDate != null and regBeginDate.trim() != '' ">
     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
</if>
<if test="regEndDate != null and regEndDate.trim() != '' "  >
     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
</if>
<if test="channelLabelList != null and channelLabelList.size()!=0">
	AND u.ACTIVITY_TAG IN
	<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
		#{channelName}
	</foreach>
</if>


GROUP BY
	u.ACTIVITY_TAG

</select>

<select id="queryInvestUserNum" resultType="io.renren.entity.ChannelInvestTimesEntity">
	<!-- 投资人数 -->
	SELECT
		u.ACTIVITY_TAG channelLabel,
		count(DISTINCT u.user_id) investUserNum
	FROM
		edw_merge_project_detail p,
		dm_report_merge_user u
	WHERE
		1 = 1
	AND p.USER_ID = u.USER_ID
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and p.ADDTIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="invEndDate != null and invEndDate.trim() != '' "  >
	     <![CDATA[ and p.ADDTIME <=  #{invEndDate}  ]]>
	</if>
	AND p.TENDER_SUBJECT IN (1, 2)
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="regEndDate != null and regEndDate.trim() != '' "  >
	     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
	</if>
	<if test="channelLabelList != null and channelLabelList.size()!=0">
		AND u.ACTIVITY_TAG IN
		<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
			#{channelName}
		</foreach>
	</if>

	GROUP BY
		u.ACTIVITY_TAG

</select>

<select id="queryInvestAmount" resultType="io.renren.entity.ChannelInvestTimesEntity">
	<!-- 累计投资金额 -->
	SELECT
		u.ACTIVITY_TAG channelLabel,
		sum(p.TENDER_CAPITAL) investAmount
	FROM
		edw_merge_project_detail p,
		dm_report_merge_user u
	WHERE
		1 = 1
	AND p.USER_ID = u.USER_ID
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and p.ADDTIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="invEndDate != null and invEndDate.trim() != '' "  >
	     <![CDATA[ and p.ADDTIME <=  #{invEndDate}  ]]>
	</if>
	AND p.TENDER_SUBJECT IN (1, 2)
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="regEndDate != null and regEndDate.trim() != '' "  >
	     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
	</if>
	<if test="channelLabelList != null and channelLabelList.size()!=0">
		AND u.ACTIVITY_TAG IN
		<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
			#{channelName}
		</foreach>
	</if>

	GROUP BY
		u.ACTIVITY_TAG

</select>

<select id="queryInvestYearAmount" resultType="io.renren.entity.ChannelInvestTimesEntity">
	<!-- 累计投资年华金额 -->
	SELECT
		u.ACTIVITY_TAG channelLabel,
		sum(IFNULL(p.TENDER_CAPITAL,0)*IFNULL(p.BORROW_PERIOD,0)/360) investYearAmount
	FROM
		edw_merge_project_detail p,
		dm_report_merge_user u
	WHERE
		1 = 1
	AND p.USER_ID = u.USER_ID
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and p.ADDTIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="invEndDate != null and invEndDate.trim() != '' "  >
	     <![CDATA[ and p.ADDTIME <=  #{invEndDate}  ]]>
	</if>
	AND p.TENDER_SUBJECT IN (1, 2)
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="regEndDate != null and regEndDate.trim() != '' "  >
	     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
	</if>
	<if test="channelLabelList != null and channelLabelList.size()!=0">
		AND u.ACTIVITY_TAG IN
		<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
			#{channelName}
		</foreach>
	</if>

	GROUP BY
		u.ACTIVITY_TAG

</select>

<select id="queryFirstInvestRedMoney" resultType="io.renren.entity.ChannelInvestTimesEntity">
	<!-- 首投使用红包金额-->
	call first_invest_use_red_money_investtimes(#{regBeginDate},#{regEndDate},#{invEndDate});

<!-- 不再使用临时表 -->
<!-- 	select u.channelLabel,u.firstInvestRedMoney from first_invest_use_red_money_investtimes_tmp u where 1=1 -->
<!-- <if test="channelLabelList != null and channelLabelList.size()!=0"> -->
<!-- 	AND u.channelLabel IN -->
<!-- 	<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")"> -->
<!-- 		#{channelName} -->
<!-- 	</foreach> -->
<!-- </if> -->

</select>
<select id="queryAllRedMoney" resultType="io.renren.entity.ChannelInvestTimesEntity">
<!-- 累计使用红包金额-->
SELECT
	u.ACTIVITY_TAG channelLabel,
	sum(IFNULL(p.TEND_VOUCHE,0)) allRedMoney
FROM
	edw_merge_project_detail p,
	dm_report_merge_user u
WHERE
	1 = 1
AND p.USER_ID = u.USER_ID
and p.TENDER_SUBJECT in (1,2)
<if test="regBeginDate != null and regBeginDate.trim() != '' ">
     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
</if>
<if test="regEndDate != null and regEndDate.trim() != '' "  >
     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
</if>
<if test="regBeginDate != null and regBeginDate.trim() != '' ">
     <![CDATA[ and p.ADDTIME  >=  #{regBeginDate}  ]]>
</if>
<if test="invEndDate != null and invEndDate.trim() != '' "  >
     <![CDATA[ and p.ADDTIME <=  #{invEndDate}  ]]>
</if>
<if test="channelLabelList != null and channelLabelList.size()!=0">
	AND u.ACTIVITY_TAG IN
	<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
		#{channelName}
	</foreach>
</if>
GROUP BY
	u.ACTIVITY_TAG
</select>

<select id="queryDdzPerInvestAmount" resultType="io.renren.entity.ChannelInvestTimesEntity">
	<!-- 点点赚投资天数，点点赚平均投资金额-->
	SELECT
		u.ACTIVITY_TAG channelLabel,
		count(1) ddzInvestDays,
		sum(IFNULL(d.INCOME_, 0)) / count(DISTINCT d.USER_ID_) ddzPerInvestAmount
	FROM
		ODS_MJKF_DDZ_INV_ACCOUNTLOG_DD d,
		dm_report_merge_user u
	WHERE
		1 = 1
	AND d.USER_ID_ = u.USER_ID
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and d.CREATED_TIME_  >=  #{regBeginDate}  ]]>
	</if>
	<if test="invEndDate != null and invEndDate.trim() != '' "  >
	     <![CDATA[ and d.CREATED_TIME_ <=  #{invEndDate}  ]]>
	</if>
	<if test="regBeginDate != null and regBeginDate.trim() != '' ">
	     <![CDATA[ and u.REGISTER_TIME  >=  #{regBeginDate}  ]]>
	</if>
	<if test="regEndDate != null and regEndDate.trim() != '' "  >
	     <![CDATA[ and u.REGISTER_TIME <=  #{regEndDate}  ]]>
	</if>
	AND d.TYPE_ IN ('B', 'RP')
	<if test="channelLabelList != null and channelLabelList.size()!=0">
		AND u.ACTIVITY_TAG IN
		<foreach item="channelName" collection="channelLabelList" open="(" separator="," close=")">
			#{channelName}
		</foreach>
	</if>
	GROUP BY
		u.ACTIVITY_TAG

</select>
	
</mapper>